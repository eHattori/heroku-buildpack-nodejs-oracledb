FROM ubuntu
MAINTAINER Eduardo Hattori <eduardo.ferreira@fcamara.com.br>

RUN apt-get update \
  && apt-get install -y libaio1 \
  && apt-get install -y build-essential \
  && apt-get install -y unzip \
  && apt-get install -y curl  \
  && apt-get install -y nano  \
  && apt-get install -y telnet

#Install NodeJs
#RUN curl -sL https://deb.nodesource.com/setup_0.12 | sudo bash -
RUN curl -sL https://deb.nodesource.com/setup_4.x | sudo -E bash -
RUN apt-get install --yes nodejs

#Install git
RUN apt-get -y install python-software-properties git build-essential
RUN apt-get install --yes git
RUN apt-get install --yes  openssh-server openssh-client

# Make ssh dir
RUN mkdir /root/.ssh/

# Copy over private key, and set permissions
ADD id_rsa /root/.ssh/
ADD id_rsa.pub /root/.ssh/
RUN chmod 700 /root/.ssh/id_rsa
RUN chown -R root:root /root/.ssh/

# Create known_hosts
RUN touch /root/.ssh/known_hosts
WORKDIR /

# Add bitbuckets key
RUN ssh-keyscan bitbucket.org >> /root/.ssh/known_hosts

#Create Folder oracle
RUN mkdir -p opt/oracle
WORKDIR /opt/oracle

#Clone Oracle client
RUN git clone git@bitbucket.org:magazineluiza-ondemand/comercial-packages.git -b oracle-instant-12.1

RUN unzip comercial-packages/instantclient-basic-linux.x64-12.1.0.2.0.zip
RUN unzip comercial-packages/instantclient-sdk-linux.x64-12.1.0.2.0.zip
RUN unzip comercial-packages/instantclient-sqlplus-linux.x64-12.1.0.2.0.zip

RUN mv instantclient_12_1 instantclient
WORKDIR /opt/oracle/instantclient

RUN ln -s /opt/oracle/instantclient/libclntsh.so.12.1 /opt/oracle/instantclient/libclntsh.so
RUN ln -s /opt/oracle/instantclient/libocci.so.12.1 /opt/oracle/instantclient/libocci.so

ENV LD_LIBRARY_PATH="/opt/oracle/instantclient"
ENV OCI_HOME="/opt/oracle/instantclient"
ENV OCI_LIB_DIR="/opt/oracle/instantclient"
ENV OCI_INCLUDE_DIR="/opt/oracle/instantclient/sdk/include"
ENV NODE_ENV="development"
ENV NODE_SCHEDULE="true"

#Install PM2 Global
RUN npm install pm2 -g

#Download repository project
WORKDIR /home
#RUN git clone git@bitbucket.org:magazineluiza-ondemand/ml-carreteiro.git
RUN mkdir ml-carreteiro

WORKDIR /home/ml-carreteiro

#Install npm
RUN npm install graceful-fs
#RUN npm install

#Clean
RUN rm -rf /opt/oracle/comercial-packages && rm -rf /var/lib/apt/lists/

EXPOSE 8001